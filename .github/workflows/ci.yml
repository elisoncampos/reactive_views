name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rubocop:
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
      CI: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Run RuboCop
        run: bundle exec rubocop

  unit:
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
      CI: true
      RV_VITE_PORT: 5174
      RV_SSR_PORT: 5175

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: |
          set -euo pipefail

          # Root deps (SSR server)
          npm ci

          # Dummy app deps
          pushd spec/dummy >/dev/null
          rm -rf node_modules package-lock.json
          npm install --include=dev --no-audit --no-fund
          popd >/dev/null

      - name: Run unit + integration specs (non-system, non-production)
        run: |
          set -euo pipefail

          node node/ssr/server.mjs &
          SSR_PID=$!
          echo "SSR server started with PID ${SSR_PID}"

          pushd spec/dummy >/dev/null
          npm exec -- vite --config vite.test.config.ts &
          VITE_PID=$!
          echo "Vite server started with PID ${VITE_PID}"
          popd >/dev/null

          cleanup() {
            echo "Stopping background servers..."
            kill ${SSR_PID} ${VITE_PID} || true
          }
          trap cleanup EXIT

          wait_for() {
            local url="$1"
            echo "Waiting for ${url}..."
            for attempt in $(seq 1 60); do
              if curl -fsS "${url}" >/dev/null 2>&1; then
                echo "${url} is ready"
                return 0
              fi
              sleep 1
            done
            echo "Timed out waiting for ${url}" >&2
            exit 1
          }

          wait_for "http://localhost:${RV_SSR_PORT}/health"
          wait_for "http://localhost:${RV_VITE_PORT}/@vite/client"

          # Warm SSR once to avoid first-render timeouts
          payload=$(node -e "console.log(JSON.stringify({ componentPath: process.argv[1], props: { initialCount: 0 } }))" "$(pwd)/spec/dummy/app/views/components/Counter.tsx")
          curl -fsS -X POST "http://localhost:${RV_SSR_PORT}/render" -H "Content-Type: application/json" -d "${payload}" >/dev/null

          # IMPORTANT: unit job must NOT run production specs
          bundle exec rspec --tag ~type:system --tag ~type:production

  system:
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
      CI: true
      RV_VITE_PORT: 5174
      RV_SSR_PORT: 5175

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: |
          set -euo pipefail
          npm ci
          pushd spec/dummy >/dev/null
          rm -rf node_modules package-lock.json
          npm install --include=dev --no-audit --no-fund
          popd >/dev/null

      - name: Run system specs
        run: |
          set -euo pipefail

          node node/ssr/server.mjs &
          SSR_PID=$!
          echo "SSR server started with PID ${SSR_PID}"

          pushd spec/dummy >/dev/null
          npm exec -- vite --config vite.test.config.ts &
          VITE_PID=$!
          echo "Vite server started with PID ${VITE_PID}"
          popd >/dev/null

          cleanup() {
            echo "Stopping background servers..."
            kill ${SSR_PID} ${VITE_PID} || true
          }
          trap cleanup EXIT

          wait_for() {
            local url="$1"
            echo "Waiting for ${url}..."
            for attempt in $(seq 1 60); do
              if curl -fsS "${url}" >/dev/null 2>&1; then
                echo "${url} is ready"
                return 0
              fi
              sleep 1
            done
            echo "Timed out waiting for ${url}" >&2
            exit 1
          }

          wait_for "http://localhost:${RV_SSR_PORT}/health"
          wait_for "http://localhost:${RV_VITE_PORT}/@vite/client"

          bundle exec rspec spec/system --order defined

  production:
    needs: [rubocop, unit, system]
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: production
      NODE_ENV: production
      CI: true
      RV_VITE_PORT: 5174
      RV_SSR_PORT: 5175
      SECRET_KEY_BASE: test-secret-key-base-for-ci-only
      RAILS_SERVE_STATIC_FILES: true
      REACTIVE_VIEWS_ALLOW_PRODUCTION_SPECS: "1"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        env:
          # Ensure devDependencies (vite) are installed even though NODE_ENV=production
          NPM_CONFIG_PRODUCTION: "false"
        run: |
          set -euo pipefail
          npm ci
          pushd spec/dummy >/dev/null
          rm -rf node_modules package-lock.json
          npm install --include=dev --no-audit --no-fund
          popd >/dev/null

      - name: Build production assets (dummy app)
        run: |
          set -euo pipefail
          pushd spec/dummy >/dev/null
          npm exec -- vite build --config vite.config.mts
          popd >/dev/null

      - name: Run production specs
        run: |
          set -euo pipefail

          NODE_ENV=production node node/ssr/server.mjs &
          SSR_PID=$!
          echo "SSR server started with PID ${SSR_PID}"

          cleanup() {
            echo "Stopping SSR server..."
            kill ${SSR_PID} || true
          }
          trap cleanup EXIT

          for attempt in $(seq 1 60); do
            if curl -fsS "http://localhost:${RV_SSR_PORT}/health" >/dev/null 2>&1; then
              echo "SSR server ready"
              break
            fi
            sleep 1
          done

          bundle exec rspec spec/production --tag ~type:system
