name: Release

on:
  push:
    branches: [release]
  workflow_dispatch:
    inputs:
      rubygems_only:
        description: "Only push to RubyGems (build + push, no GitHub release). Use when release already exists and you fixed an oops."
        required: false
        default: false
        type: boolean

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production # must match the Environment set on RubyGems Trusted Publisher
    permissions:
      contents: write
      id-token: write # required for RubyGems Trusted Publishing (OIDC)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Get version
        id: version
        run: |
          V=$(sed -n 's/.*VERSION = "\(.*\)".*/\1/p' lib/reactive_views/version.rb)
          echo "version=${V}" >> "$GITHUB_OUTPUT"
          echo "Resolved version: ${V}"

      - name: Check if release already exists
        id: check
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" 2>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release v${{ steps.version.outputs.version }} already exists; skipping publish."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No release for v${{ steps.version.outputs.version }}; will create and publish."
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build gem
        if: steps.check.outputs.exists != 'true' || github.event.inputs.rubygems_only == 'true'
        run: |
          mkdir -p pkg
          gem build reactive_views.gemspec --output pkg/reactive_views-${{ steps.version.outputs.version }}.gem

      - name: Create GitHub release
        if: steps.check.outputs.exists != 'true' && github.event.inputs.rubygems_only != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          V="${{ steps.version.outputs.version }}"
          TAG="v${V}"
          GEM="pkg/reactive_views-${V}.gem"
          PREV=$(git describe --tags --abbrev=0 2>/dev/null || true)
          if [ -n "$PREV" ]; then
            gh release create "$TAG" "$GEM" --title "$TAG" --generate-notes --notes-start-tag "$PREV"
          else
            gh release create "$TAG" "$GEM" --title "$TAG" --generate-notes
          fi

      - name: Configure RubyGems credentials (Trusted Publishing)
        uses: rubygems/configure-rubygems-credentials@v1.0.0
        with:
          gem-server: "https://oidc-api-token.rubygems.org"
          audience: "https://oidc-api-token.rubygems.org"

      - name: Publish to RubyGems
        if: steps.check.outputs.exists != 'true' || github.event.inputs.rubygems_only == 'true'
        run: |
          set -euo pipefail
          V="${{ steps.version.outputs.version }}"
          GEM="pkg/reactive_views-${V}.gem"
          gem push "$GEM"
          echo "Published reactive_views ${V} to RubyGems."
